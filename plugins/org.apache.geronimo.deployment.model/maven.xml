<?xml version="1.0" encoding="ISO-8859-1"?>
<project default="default" xmlns:j="jelly:core" xmlns:ant="jelly:ant">

  <goal name="default">
    <attainGoal name="build"/>
  </goal>
  
  <goal name="build">
    <attainGoal name="jar:install"/>
  </goal>
  
  <preGoal name="java:compile">
    <attainGoal name="importschemas"/>
  </preGoal>
  
  <goal name="rebuild">
    <attainGoal name="clean"/>
    <attainGoal name="build"/>
  </goal>
  
  <goal name="importschemas">
    <j:forEach var="artifact" items="${pom.artifacts}"> 
    <j:set var="group" value="${artifact.dependency.groupId}"/>
      <j:if test="${group.equals('geronimo') || group.equals('openejb')}">
          <ant:unzip src="${artifact.path}" dest="${maven.build.dir}/temp">
            <ant:patternset>
             <ant:include name="META-INF/schema/*.xsd"/>
             <ant:include name="**/xml.xsd"/>
           </ant:patternset>
         </ant:unzip>  
      </j:if>      
    </j:forEach> 
    
    <ant:move todir="${maven.build.dir}/schema" flatten="true">
      <ant:fileset dir="${maven.build.dir}/temp/">
        <ant:include name="**/*.xsd"/>
      </ant:fileset>
    </ant:move>
    
    <ant:delete dir="${maven.build.dir}/temp"/>
    
    <!-- update include paths in all schemas -->
    <ant:fileScanner var="schemaScanner">
      <ant:fileset dir="${maven.build.dir}/schema">
        <ant:include name="*.xsd"/>
      </ant:fileset>
    </ant:fileScanner>
    <j:forEach var="schema" items="${schemaScanner.iterator()}">
      <replaceregexp file="${schema}" match="schemaLocation=&quot;(.*/)(.*xsd)" replace="schemaLocation=&quot;\2" byline="true"/>
    </j:forEach>     
  </goal>
  
  <goal name="codegen" prereqs="importschemas">
    <echo>Starting Workbench...</echo>
    <ant:java fork="true" jar="${eclipse.home}/startup.jar" failonerror="true">
      <ant:jvmarg value="-Djava.endorsed.dirs=${maven.repo.local}/xerces/jars/"/>
      <ant:arg value="-data"/>
      <ant:arg value="../temp"/>
      <ant:arg value="-application"/>
      <ant:arg value="org.eclipse.ant.core.antRunner"/>
      <ant:arg value="-buildfile"/>
      <ant:arg value="${basedir}/build.xml"/>
   </ant:java> 
  </goal>
  
</project>
